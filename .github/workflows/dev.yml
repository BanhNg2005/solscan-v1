# Deploy branch dev to dev environment
#
# To get started with Next.js see: https://nextjs.org/docs/getting-started
#

name: DEV CI/CD UI V2

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ['banh']

jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - name: Deploy Solscan Dev Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_DEPLOY_HOST }}
          username: ${{ secrets.DEV_DEPLOY_USER }}
          key: ${{ secrets.DEV_DEPLOY_KEY }}
          password: ${{ secrets.DEV_DEPLOY_PASSWORD }}
          port: 22
          script: |
            echo "=== Initial Setup ==="
            whoami
            echo "Home: $HOME"
            
            echo "=== Installing/Setting up NVM in user home ==="
            # Install NVM in the current user's home if it doesn't exist
            if [ ! -d "$HOME/.nvm" ]; then
              echo "Installing NVM for current user..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
              export NVM_DIR="$HOME/.nvm"
            else
              export NVM_DIR="$HOME/.nvm"
            fi
            
            # Try to load NVM from multiple locations
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              echo "Loading NVM from $HOME/.nvm/nvm.sh"
              source "$HOME/.nvm/nvm.sh"
            elif [ -s "/home/banh/.nvm/nvm.sh" ]; then
              echo "Loading NVM from /home/banh/.nvm/nvm.sh"
              source "/home/banh/.nvm/nvm.sh"
              export NVM_DIR="/home/banh/.nvm"
            else
              echo "ERROR: Cannot find NVM installation"
              exit 1
            fi
            
            # Install Node if not available
            if ! command -v node >/dev/null 2>&1; then
              echo "Installing Node.js..."
              nvm install --lts
              nvm use --lts
            fi
            
            echo "=== Verifying Node/NPM ==="
            node --version || (echo "ERROR: Node still not available" && exit 1)
            npm --version || (echo "ERROR: NPM still not available" && exit 1)
            
            echo "=== Setting up project ==="
            PROJECT_DIR="$HOME/clone-solscan"
            
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "Cloning repository to $PROJECT_DIR..."
              git clone -b banh https://github.com/BanhNg2005/solscan-v1 "$PROJECT_DIR"
            fi
            
            echo "=== Deploying ==="
            cd "$PROJECT_DIR"
            echo "Current directory: $(pwd)"
            echo "Files in directory:"
            ls -la
            
            # Pull latest changes first
            echo "=== Pulling latest code ==="
            git pull origin banh
            
            # Check if redeploy_dev.sh exists and run it
            if [ -f "redeploy_dev.sh" ]; then
              echo "Found redeploy_dev.sh, making it executable..."
              chmod +x redeploy_dev.sh
              echo "Running deployment script..."
              bash redeploy_dev.sh
            else
              echo "redeploy_dev.sh not found in $(pwd)"
              echo "Available files:"
              find . -name "*.sh" -type f 2>/dev/null || echo "No .sh files found"
              echo "Running manual deployment..."
              
              # Manual deployment steps
              echo "📦 Installing dependencies..."
              npm install
              
              echo "🏗️ Building app..."
              npm run build
              
              echo "🚀 Installing/updating PM2..."
              npm install pm2 -g >/dev/null || echo "PM2 installation skipped"

              echo "🚀 Restarting app with PM2..."
              pm2 restart clone-solscan || pm2 start ecosystem.config.js --name clone-solscan
            fi
